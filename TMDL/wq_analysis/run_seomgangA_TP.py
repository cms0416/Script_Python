
# %% [markdown]
# ******************************************************************************
# # 섬강A 수질 및 기상자료 분석


# %% [markdown]
# ******************************************************************************
# ### 1. 라이브러리 로드 및 설정 정의


# %% ---------------------------------------------------------------------------
# 라이브러리 로드
import sys
from pathlib import Path
import pandas as pd  # 엑셀 저장(ExcelWriter) 및 데이터 핸들링용

# %% ---------------------------------------------------------------------------
# 패키지 경로 설정 (필요한 경우)
ROOT = Path(r"E:/Coding/Script_Python")
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

# %% ---------------------------------------------------------------------------
# 사용자 정의 패키지 로드
from TMDL.wq_analysis.package.config import ProjectConfig, PlotConfig
from TMDL.wq_analysis.package import 기상자료, 수질자료, 달성률, 통계분석, 시각화

# %% ---------------------------------------------------------------------------
# 설정(Config) 정의
cfg = ProjectConfig(
    단위유역="섬강A",
    기상대="횡성",
    시작연도=2015,
    종료연도=2024,
    수질항목="TP",   # "TP", "BOD" 등 문자열로 변경
)

# 설정 확인
cfg


# %% [markdown]
# ******************************************************************************
# ### 2. 강수량 분석


# %% ---------------------------------------------------------------------------
# 기상자료(시단위) 정리
기상자료_시단위 = 기상자료.load_weather_hourly(cfg)
기상자료_시단위


# %% ---------------------------------------------------------------------------
# 일별 최대 시간강우량 및 강우강도 여부, 누적강수 등
기상지표_일별 = 기상자료.build_daily_indicators(기상자료_시단위)
기상지표_일별

# %% ---------------------------------------------------------------------------
# 연월별 강수량 합계
강수량_연월별_합계_소계, 강수량_월별_평균 = 기상자료.summarize_rainfall(기상지표_일별)
강수량_연월별_합계_소계

# %% ---------------------------------------------------------------------------------------
# 월별 평균 강수량
강수량_월별_평균

# %% ---------------------------------------------------------------------------
# 연도별 기상 지표 요약
기상지표_연도별 = 기상자료.summarize_weather_yearly(기상지표_일별)
기상지표_연도별


# %% [markdown]
# ******************************************************************************
# ### 3. 수질데이터(총량측정망) 정리


# %% ---------------------------------------------------------------------------
# 목표수질 불러오기
목표수질 = 수질자료.load_target_quality(cfg)
목표수질

# %% ---------------------------------------------------------------------------
# 총량측정망 불러오기
총량측정망_원본 = 수질자료.load_tmdl_raw(cfg, 목표수질)
총량측정망_원본

# %% ---------------------------------------------------------------------------
# 총량측정망 자료 정리 및 기상자료 병합
총량측정망, 총량측정망_기상 = 수질자료.prepare_tmdl(
    cfg,
    총량측정망_원본,
    목표수질,
    기상지표_일별
)
총량측정망

# %% ---------------------------------------------------------------------------
## 일별 기상자료와 총량측정망 자료 합치기
총량측정망_기상

# %% [markdown]
# ******************************************************************************
# ### 4. 달성률


# %% ---------------------------------------------------------------------------
# 유황구간별 달성률
달성률_유황구간별 = 달성률.compute_by_flow(총량측정망)
달성률_유황구간별

# %% ---------------------------------------------------------------------------
# 계절별 달성률
달성률_계절별 = 달성률.compute_by_season(총량측정망)
달성률_계절별

# %% ---------------------------------------------------------------------------
# 월별 달성률 및 월별 강수량 평균
달성률_월별 = 달성률.compute_by_month(총량측정망, 강수량_월별_평균)
달성률_월별

# %% ---------------------------------------------------------------------------
# 연도 별 달성률 및 강우강도 지표
달성률_연도별 = 달성률.compute_by_year(총량측정망, cfg.analyte.col, cfg.analyte.name)
달성률_강우강도_연도별 = 달성률.merge_with_weather(달성률_연도별, 기상지표_연도별)
달성률_강우강도_연도별


# %% [markdown]
# ******************************************************************************
# ### 5. 유역내 측정지점 별 정리(수질측정망)


# %% ---------------------------------------------------------------------------
# 유역내 측정지점 별 평균수질, 달성률 정리
수질측정망, 수질측정망_평균, 수질측정망_결과 = 수질자료.load_monitoring(cfg, 목표수질)
수질측정망_결과


# %% [markdown]
# ******************************************************************************
# ### 6. 통계 분석


# %% ---------------------------------------------------------------------------
# 분석 대상 컬럼
corr_cols = [
    cfg.analyte.col, 'SS', '유량',
    '누적강수_3일', '누적강수_4일', '누적강수_5일',
    '평균기온', '일강수량',
    'COD', '수온', 'TOC', 'TN', 'BOD', 'pH', 'EC', 'DO'
]

# NaN 제거 및 상관계수, p-value 계산
corr_matrix, pval_matrix = 통계분석.compute_corr(총량측정망_기상, corr_cols)
corr_matrix

# %% ---------------------------------------------------------------------------
# 상관계수 테이블에서 TP(or BOD) 기준 정렬
analyte_name = cfg.analyte.name
corr_series = corr_matrix[analyte_name].drop(analyte_name)
corr_sorted = corr_series.sort_values(ascending=False).to_frame(name='상관계수')
corr_sorted


# %% [markdown]
# ******************************************************************************
# ### 7. 데이터 시각화


# %% ---------------------------------------------------------------------------
## 상관계수 히트맵(전체)
시각화.plot_corr_heatmap(
    cfg=cfg,
    corr_matrix=corr_matrix,
    pval_matrix=pval_matrix,
)

# %% ---------------------------------------------------------------------------
## 상관계수 히트맵2(해당 수질 항목 행만 표현)
시각화.plot_target_corr_heatmap(cfg, corr_matrix, pval_matrix)

# %% ---------------------------------------------------------------------------
## 유량 / 수질(T-P) 그래프
# PlotConfig 설정
plot_cfg_flow = PlotConfig(
    flow_quality_ylim=(0.006, 0.5),   # 수질 y축
    flow_ylim=(0, 200),             # 유량 y축
)
# 그래프 작성
시각화.plot_flow_vs_quality(
    cfg=cfg,
    총량측정망=총량측정망,
    목표수질=목표수질,
    plot_cfg=plot_cfg_flow,
)

# %% ---------------------------------------------------------------------------
## 강수 / 수질(T-P) 그래프
# PlotConfig 설정
plot_cfg_rain = PlotConfig(
    rain_quality_ylim=(0.005, 1),
    rain_ylim=None,          # 필요 시만 설정
    rain_start_year=2020,    # 표시 시작 연도
)
# 그래프 작성
시각화.plot_rain_vs_quality(
    cfg=cfg,
    총량측정망_기상=총량측정망_기상,
    목표수질=목표수질,
    plot_cfg=plot_cfg_rain,
)

# %% ---------------------------------------------------------------------------
## 연도 별 박스플롯
# PlotConfig 설정
plot_cfg_year_box = PlotConfig(
    box_quality_ylim=(0.005, 1),
    box_flow_ylim=None,      # 필요 시 설정
)
# 그래프 작성
시각화.plot_yearly_box(
    cfg=cfg,
    총량측정망=총량측정망,
    목표수질=목표수질,
    plot_cfg=plot_cfg_year_box,
)

# %% ---------------------------------------------------------------------------
## 누적강수 3일 / 수질(T-P) 그래프
# PlotConfig 설정
plot_cfg_cumrain = PlotConfig(
    cumrain_quality_ylim=None,    # 필요할 때만 값 지정
)
# 그래프 작성
시각화.plot_cumrain_vs_quality(
    cfg=cfg,
    총량측정망=총량측정망,
    목표수질=목표수질,
    plot_cfg=plot_cfg_cumrain,
)

# %% ---------------------------------------------------------------------------
## 강우 이벤트별 수질 영향 분석(박스플롯)
# PlotConfig 설정
plot_cfg_event = PlotConfig(
    event_quality_ylim=(0.005, 1),
)
# 그래프 작성
시각화.plot_rain_event_box(
    cfg=cfg,
    총량측정망=총량측정망,
    목표수질=목표수질,
    plot_cfg=plot_cfg_event,
    # flag_col 기본값: '고강도강우_발생여부_3일누적'
)

# %% ---------------------------------------------------------------------------
## 유역 내 측정지점 별 박스플롯
# PlotConfig 설정
plot_cfg_station = PlotConfig(
    station_quality_ylim=(0.0009, 1),
    station_order=["계천2", "금계천2", "전천", "섬강1", "섬강2", "섬강3"],
)
# 그래프 작성
시각화.plot_station_box(
    cfg=cfg,
    수질측정망=수질측정망,
    목표수질=목표수질,
    plot_cfg=plot_cfg_station,
)


# %% [markdown]
# ******************************************************************************
# ### 8. 분석 결과 엑셀 내보내기


# %% ---------------------------------------------------------------------------
with pd.ExcelWriter(cfg.path_output, engine="openpyxl") as writer:
    총량측정망.to_excel(writer, sheet_name="수질현황", index=False)
    달성률_유황구간별.to_excel(writer, sheet_name="달성률_유황구간별", index=False)
    달성률_계절별.to_excel(writer, sheet_name="달성률_계절별", index=False)
    달성률_월별.to_excel(writer, sheet_name="달성률_월별", index=False)
    달성률_강우강도_연도별.to_excel(writer, sheet_name="달성률_강우강도_연도별", index=False)

print(">> 엑셀 파일 저장 완료:", cfg.path_output)

# %% ---------------------------------------------------------------------------
# 상관계수 결과 엑셀로 내보내기
with pd.ExcelWriter(cfg.path_corr_output) as writer:
    corr_matrix.to_excel(writer, sheet_name="상관계수")
    pval_matrix.to_excel(writer, sheet_name="p값")

print(">> 상관계수 엑셀 파일 저장 완료:", cfg.path_corr_output)

# %% ---------------------------------------------------------------------------
# 시각화 모듈 다시 로드
import importlib
from TMDL.wq_analysis.package import 시각화

importlib.reload(시각화)


# %%
